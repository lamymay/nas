<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>cms</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }

        #top-bar {
            padding: 10px;
            background: #f5f5f5;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        #top-left {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
        }

        #media-type-buttons button {
            background: #e8e8e8;
            border: 1px solid #ccc;
            color: #333;
            padding: 5px 10px;
            border-radius: 4px;
        }
        #media-type-buttons button.active {
            background: #007bff;
            border-color: #007bff;
            color: #fff;
        }

        #tags-search-bar { display: flex; align-items: center; gap: 5px; flex-wrap: wrap; }
        #tags-area { display: flex; gap: 10px; flex-wrap: wrap; padding: 10px; background: #fafafa; }

        .tag-group {
            padding: 15px 20px;
            background: #d5e8d4;
            border-radius: 6px;
            cursor: pointer;
            user-select: none;
            font-weight: bold;
        }

        #media-list { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; position: relative; }
        .media-item { width: 120px; border: 1px solid #ccc; padding: 5px; text-align: center; cursor: pointer; }
        .media-item.selected {
            border: 2px solid #007bff !important;
            background: rgba(0,123,255,0.12);
            box-shadow: 0 0 8px rgba(0,123,255,0.5);
            transform: scale(1.02);
        }

        .media-item div {
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 12px;
            margin-top: 2px;
        }

        .media-item img, .media-item video {
            width: 100%;
            height: 80px;
            object-fit: cover;
            display: block;
        }

        input[type="text"], textarea { padding: 4px 6px; border-radius: 4px; border: 1px solid #ccc; }
        button { padding: 5px 10px; border-radius: 4px; border: 1px solid #007bff; background: #007bff; color: #fff; cursor: pointer; }
        button:hover { background: #0056b3; border-color: #0056b3; }

        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast {
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 10px 15px;
            margin-top: 8px;
            border-radius: 8px;
            font-size: 14px;
            min-width: 120px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            transform: translateY(-10px);
        }
        .toast.show { opacity: 1; transform: translateY(0); }

        .marquee-selection {
            position: absolute;
            border: 1px dashed #007bff;
            background: rgba(0,123,255,0.1);
            pointer-events: none;
            z-index: 999;
        }

        /* 设置弹窗增强 */
        #settings-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
        }
        .modal-content {
            background: white;
            width: 550px;
            margin: 80px auto;
            padding: 25px;
            border-radius: 12px;
            position: relative;
        }
        #pathsTextarea {
            width: 100%;
            height: 200px;
            margin-top: 10px;
            box-sizing: border-box;
            font-family: monospace;
            line-height: 1.5;
            resize: vertical;
        }
    </style>
</head>
<body>

<div id="top-bar">
    <div id="top-left">
        <div id="media-type-buttons">
            <button data-type="VIDEO" onclick="toggleMediaType(this)" type="button">VIDEO</button>
            <button data-type="IMAGE" onclick="toggleMediaType(this)" type="button">IMAGE</button>
            <button data-type="FILE" onclick="toggleMediaType(this)" type="button">FILE</button>
            <button data-type="THUMBNAIL" onclick="toggleMediaType(this)" type="button">THUMBNAIL</button>
            <button data-type="OTHERS" onclick="toggleMediaType(this)" type="button">OTHERS</button>
        </div>

        <input id="searchKeyword" placeholder="关键字" type="text"/>
        <button onclick="loadMedia()">搜索媒体</button>
    </div>
    <button onclick="toggleSettings(true)" style="background: #666; border-color: #666;">系统设置</button>
</div>

<div id="settings-modal" onclick="toggleSettings(false)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 style="margin-top: 0;">管理设置</h3>
        <hr/>
        <div style="margin-bottom: 25px;">
            <h4>缩略图操作</h4>
            <button onclick="refreshThumbnails()">刷新所有缩略图</button>
        </div>
        <div>
            <div>
                <h4>扫描路径配置 (每行一个路径)</h4>

            </div>
            <textarea id="pathsTextarea"
                      placeholder="请输入绝对路径，例如：&#10;D:\Media\Movies&#10;E:\Photos"></textarea>
            <div style="margin-top: 15px; display: flex; justify-content: space-between;">
                <button onclick="saveAllPaths()" style="background: #28a745; border-color: #28a745;">
                    保存扫描路径(系统延迟自动更新媒体库)
                </button>
                <button onclick="toggleSettings(false)" style="background: #eee; border-color: #ccc; color: #333;">
                    关闭
                </button>
            </div>
        </div>
    </div>
</div>

<div>
    <input id="newTagName" placeholder="新标签名称" type="text"/>
    <button onclick="createTag()">创建标签</button>
</div>

<div id="tags-search-bar">
    <input id="tagKeyword" placeholder="搜索标签" type="text"/>
    <button onclick="clearTagSearch()">清空标签条件</button>
    <button onclick="fetchTags()">通过标签过滤</button>

    <button onclick="showAllMedia()">显示全部(强制忽略标签过滤)</button>
    <button onclick="selectAllMedia()">全选</button>
    <button onclick="clearAllSelection()">取消全选</button>
</div>

<div id="tags-area"></div>
<div id="media-list"></div>
<div id="toast-container"></div>

<script>
    const API = {
        updateTags: "/nas/api/media/addTag",
        listMedia: "/nas/api/media/list",
        removeTags: "/nas/api/media/removeTags",
        listTags: "/nas/api/media/tag/list",
        createTag: "/nas/api/media/tag/saves",
        matchThumbnails: "/nas/api/media/matchThumbnails",
        saveResource: "/nas/media/resource/saves",
        listResource: "/nas/media/resource/listAll",
        removeResource: "/nas/media/resource/removes"
    };

    let tagGroups = [];
    let selectedMedia = new Set();
    let selectedMediaTypes = new Set(["VIDEO", "IMAGE"]);
    let originalPaths = [];

    let marquee = null;
    let startX = 0, startY = 0;
    let isDraggingMarquee = false;

    window.onload = function() {
        fetchTags();
        loadMedia();
        document.querySelectorAll("#media-type-buttons button").forEach(btn => {
            if (selectedMediaTypes.has(btn.dataset.type)) btn.classList.add("active");
        });

        const mediaList = document.getElementById("media-list");
        mediaList.addEventListener("mousedown", e => {
            if (e.target !== mediaList) return;
            isDraggingMarquee = true;
            startX = e.pageX;
            startY = e.pageY;
            marquee = document.createElement("div");
            marquee.className = "marquee-selection";
            marquee.style.left = startX + "px";
            marquee.style.top = startY + "px";
            document.body.appendChild(marquee);
        });

        window.addEventListener("mousemove", e => {
            if (!isDraggingMarquee || !marquee) return;
            const x = Math.min(e.pageX, startX), y = Math.min(e.pageY, startY);
            const w = Math.abs(e.pageX - startX), h = Math.abs(e.pageY - startY);
            marquee.style.left = x + "px";
            marquee.style.top = y + "px";
            marquee.style.width = w + "px";
            marquee.style.height = h + "px";

            document.querySelectorAll(".media-item").forEach(item => {
                const rect = item.getBoundingClientRect();
                const overlap = !(rect.right < x || rect.left > x + w || rect.bottom < y || rect.top > y + h);
                if (overlap) {
                    selectedMedia.add(item.dataset.code);
                    item.classList.add("selected");
                } else if (!e.ctrlKey) {
                    selectedMedia.delete(item.dataset.code);
                    item.classList.remove("selected");
                }
            });
        });

        window.addEventListener("mouseup", () => {
            if (marquee) { document.body.removeChild(marquee); marquee = null; }
            isDraggingMarquee = false;
        });
    };

    function showToast(msg, duration = 2000) {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = "toast";
        toast.textContent = msg;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add("show"), 50);
        setTimeout(() => { toast.classList.remove("show"); setTimeout(() => toast.remove(), 300); }, duration);
    }

    /* 设置弹出层管理 */
    function toggleSettings(show) {
        document.getElementById("settings-modal").style.display = show ? "block" : "none";
        if (show) fetchPathsToTextarea();
    }

    function fetchPathsToTextarea() {
        fetch(API.listResource)
            .then(r => r.json())
            .then(data => {
                originalPaths = (data || []).map(item => item.path);
                document.getElementById("pathsTextarea").value = originalPaths.join('\n');
            });
    }

    async function saveAllPaths() {
        const text = document.getElementById("pathsTextarea").value.trim();
        const currentPaths = text.split('\n').map(p => p.trim()).filter(p => p !== "");

        const toDelete = originalPaths.filter(p => !currentPaths.includes(p));
        const toAdd = currentPaths.filter(p => !originalPaths.includes(p));

        if (toDelete.length === 0 && toAdd.length === 0) {
            showToast("配置未发生变化");
            return;
        }

        try {
            if (toDelete.length > 0) {
                await fetch(API.removeResource, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ folders: toDelete })
                });
            }
            if (toAdd.length > 0) {
                await fetch(API.saveResource, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ folders: toAdd })
                });
            }
            showToast("保存成功，路径已同步");
            toggleSettings(false);
        } catch (err) {
            console.error(err);
            showToast("同步路径失败，请检查后端接口");
        }
    }

    async function refreshThumbnails() {
        if (!confirm("确定要刷新所有视频和图片的缩略图吗？")) return;
        try {
            const response = await fetch(API.matchThumbnails, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ force: true, width: 480, overwrite: true })
            });
            if (response.ok) {
                showToast("刷新任务已启动");
                setTimeout(() => loadMedia(), 1000);
            }
        } catch (err) { showToast("请求失败"); }
    }

    function fetchTags() {
        const keyword = document.getElementById("tagKeyword").value.trim();
        fetch(API.listTags, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ displayName: keyword || null })
        }).then(r => r.json()).then(data => { tagGroups = data || []; renderTags(); });
    }

    function clearTagSearch() { document.getElementById("tagKeyword").value = ""; fetchTags(); }

    function renderTags() {
        const div = document.getElementById("tags-area");
        div.innerHTML = "";
        tagGroups.forEach(tag => {
            const el = document.createElement("div");
            el.className = "tag-group";
            el.dataset.tag = tag.code;
            el.textContent = tag.displayName;
            el.onclick = () => { el.classList.toggle("selected"); loadMedia(); };
            el.ondrop = drop;
            el.ondragover = e => e.preventDefault();
            div.appendChild(el);
        });
    }

    function createTag() {
        const name = document.getElementById("newTagName").value.trim();
        if (!name) return showToast("请输入标签名称");
        fetch(API.createTag, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify([{ displayName: name }])
        }).then(r => r.json()).then(ok => {
            if (ok) { showToast("创建成功"); fetchTags(); }
        });
    }

    function toggleMediaType(btn) {
        const type = btn.dataset.type;
        if (selectedMediaTypes.has(type)) {
            selectedMediaTypes.delete(type);
            btn.classList.remove("active");
        } else {
            selectedMediaTypes.add(type);
            btn.classList.add("active");
        }
        loadMedia();
    }

    function selectAllMedia() {
        document.querySelectorAll(".media-item").forEach(item => {
            selectedMedia.add(item.dataset.code);
            item.classList.add("selected");
        });
    }

    function clearAllSelection() {
        selectedMedia.clear();
        document.querySelectorAll(".media-item").forEach(item => item.classList.remove("selected"));
    }

    function loadMedia(onlyUntagged = true) {
        const keyword = document.getElementById("searchKeyword").value.trim();
        const tagCodes = Array.from(document.querySelectorAll("#tags-area .tag-group.selected")).map(el => el.dataset.tag);
        fetch(API.listMedia, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                pageNumber: 1, pageSize: 90000,
                keyword: keyword || null,
                mediaTypes: Array.from(selectedMediaTypes),
                tagCodes: tagCodes.length ? tagCodes : null,
                onlyUntagged
            })
        }).then(r => r.json()).then(data => renderMediaList(data));
    }

    function showAllMedia() { loadMedia(false); }

    function renderMediaList(data) {
        const div = document.getElementById("media-list");
        div.innerHTML = "";
        const defaultIcon = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCAxMjAgODAiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9IiNlZWUiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1zaXplPSIxMiIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+Tm8gSW1hZ2U8L3RleHQ+PC9zdmc+';
        Object.keys(data).forEach(type => {
            Object.keys(data[type]).forEach(key => {
                const media = data[type][key];
                const el = document.createElement("div");
                el.className = "media-item" + (selectedMedia.has(media.code) ? " selected" : "");
                el.dataset.code = media.code;
                el.draggable = true;
                el.onclick = () => toggleSelect(el);
                el.ondragstart = drag;
                let displaySrc = (media.thumbnails && media.thumbnails.length > 0) ? media.thumbnails[0] : (media.url || "");
                el.innerHTML = `<img src="${displaySrc}" onerror="this.onerror=null;this.src='${defaultIcon}';"/><div title="${media.displayName}">${media.displayName}</div>`;
                div.appendChild(el);
            });
        });
    }

    function drag(ev) {
        const code = ev.currentTarget.dataset.code;
        if (!selectedMedia.has(code)) {
            clearAllSelection();
            selectedMedia.add(code);
            ev.currentTarget.classList.add("selected");
        }
        const codesToTransfer = Array.from(selectedMedia);
        ev.dataTransfer.setData("application/json", JSON.stringify(codesToTransfer));
        ev.dataTransfer.effectAllowed = "move";
    }

    function drop(ev) {
        ev.preventDefault();
        const tagCode = ev.currentTarget.dataset.tag;
        let codes = [];
        try {
            const data = ev.dataTransfer.getData("application/json");
            if (data) codes = JSON.parse(data);
        } catch (e) {}

        if (!codes || codes.length === 0) codes = Array.from(selectedMedia);
        if (!codes || codes.length === 0) return;

        fetch(API.updateTags, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ tagCode, fileCodes: codes })
        })
        .then(r => r.json())
        .then(res => {
            if (res.success) {
                showToast(`打标签成功，共 ${codes.length} 个文件`);
                codes.forEach(code => {
                    const el = document.querySelector(`.media-item[data-code='${code}']`);
                    if (el) el.remove();
                    selectedMedia.delete(code);
                });
            }
        });
    }

    function toggleSelect(el) {
        const code = el.dataset.code;
        if (selectedMedia.has(code)) {
            selectedMedia.delete(code);
            el.classList.remove("selected");
        } else {
            selectedMedia.add(code);
            el.classList.add("selected");
        }
    }

    window.addEventListener("keydown", function (e) {
        if (e.ctrlKey && !e.shiftKey && e.key.toLowerCase() === "a") {
            e.preventDefault();
            selectAllByKeyboard();
        }
        if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === "a") {
            e.preventDefault();
            invertSelection();
        }
    });

    function selectAllByKeyboard() {
        document.querySelectorAll(".media-item").forEach(item => {
            selectedMedia.add(item.dataset.code);
            item.classList.add("selected");
        });
    }

    function invertSelection() {
        document.querySelectorAll(".media-item").forEach(item => {
            const code = item.dataset.code;
            if (selectedMedia.has(code)) {
                selectedMedia.delete(code);
                item.classList.remove("selected");
            } else {
                selectedMedia.add(code);
                item.classList.add("selected");
            }
        });
    }
</script>
</body>
</html>