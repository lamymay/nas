<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è§†é¢‘åº“</title>
    <style>
        body { font-family: Arial, sans-serif; margin:0; background:#f9f9f9; }
        header {
            display:flex; align-items:center; gap:8px;
            padding:8px 12px; background:#fff; border-bottom:1px solid #ccc;
            position:sticky; top:0; z-index:100;
            flex-wrap:wrap; /* çª„å±ä¸‹æ¢è¡Œ */
        }
        #searchWrapper { flex:1; position:relative; display:flex; align-items:center; min-width:120px; }
        #searchInput {
            flex:1; padding:6px 30px 6px 8px; border-radius:4px; border:1px solid #ccc;
            font-size:14px; min-width:0;
        }
        #searchBtn {
            position:absolute; right:4px; cursor:pointer; font-size:16px; background:none; border:none;
        }
        #settingsBtn { padding:6px 12px; border-radius:4px; border:1px solid #ccc; background:#f0f0f0; cursor:pointer; }

        #settingsPanel {
            position:fixed; top:50px; right:10px; width:250px; max-height:80vh; background:#fff; border:1px solid #ccc;
            box-shadow:0 2px 8px rgba(0,0,0,0.1); padding:12px; display:none; flex-direction:column; gap:12px; overflow-y:auto; z-index:200;
        }
        #settingsPanel h4 { margin:0 0 6px 0; font-size:14px; }
        .btn-group { display:flex; flex-wrap:wrap; gap:4px; }
        .btn-group button {
            border:1px solid #ccc; background:#f0f0f0; padding:4px 8px; border-radius:4px; cursor:pointer; transition:0.2s;
        }
        .btn-group button.active { background:#007bff; color:#fff; border-color:#007bff; }

        .main-content { padding:12px; display:flex; flex-direction:column; gap:12px; max-width:1200px; margin:0 auto; }
        #playerContainer { display:none; flex-direction:column; width:100%; max-width:100%; background:#000; }
        #playerContainer video { width:100%; height:60vh; object-fit:contain; }
        #currentVideoInfo {
            display:flex; justify-content:space-between; align-items:center;
            padding:6px 0; background:#fff; color:#000; font-size:14px;
        }
        #currentVideoInfo .more-btn, #currentVideoInfo #shareBtn {
            cursor:pointer; padding:4px 6px; border-radius:4px; border:1px solid #ccc; background:#f0f0f0;
            margin-left:4px;
        }

        .media-grid { display:flex; flex-wrap:wrap; gap:12px; margin-top:12px; }
        .media-card { width:160px; height:90px; cursor:pointer; position:relative; overflow:hidden; border-radius:4px; background:#000; }
        .media-card img { width:100%; height:100%; object-fit:cover; display:block; transition:0.2s; }

        #toastContainer { position:fixed; top:10%; left:50%; transform:translateX(-50%); pointer-events:none; z-index:9999; }

        /* äºŒç»´ç å¼¹çª— */
        #qrModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:9999; }
        #qrModalContent { background:#fff; padding:20px; border-radius:8px; text-align:center; position:relative; }
        #qrClose { position:absolute; top:8px; right:12px; cursor:pointer; font-weight:bold; }
        #qrCodeContainer { width:160px; height:160px; margin:0 auto; }
        #qrUrlInput { margin-top:10px; width:220px; text-align:center; }

        /* è®¾ç½®åˆ·æ–°ç¼©ç•¥å›¾æŒ‰é’® */
        #refreshThumbBtn { margin-top:6px; padding:6px; border-radius:4px; border:1px solid #ccc; background:#f0f0f0; cursor:pointer; }
    </style>
</head>
<body>

<header>
    <div id="searchWrapper">
        <input id="searchInput" placeholder="æœç´¢è§†é¢‘..." type="text">
        <span id="searchBtn">ğŸ”</span>
    </div>
    <button id="settingsBtn">è®¾ç½®</button>
</header>

<div id="settingsPanel">
    <h4>æ’åºä¾æ®</h4>
    <div class="btn-group" id="orderFieldGroup">
        <button class="active" data-value="createTime">åˆ›å»ºæ—¶é—´</button>
        <button data-value="updateTime">æ›´æ–°æ—¶é—´</button>
    </div>
    <h4>æ’åºæ–¹å‘</h4>
    <div class="btn-group" id="orderDirectionGroup">
        <button class="active" data-value="desc">å€’åº</button>
        <button data-value="asc">å‡åº</button>
    </div>
    <h4>ç¼©ç•¥å›¾æ¨¡å¼</h4>
    <div class="btn-group" id="thumbModeGroup">
        <button class="active" data-value="false">æ˜¾ç¤ºç¬¬ä¸€å¼ </button>
        <button data-value="true">ç¼©ç•¥å›¾è½®æ’­</button>
    </div>
    <button id="refreshThumbBtn">åˆ·æ–°ç¼©ç•¥å›¾</button>
</div>

<div class="main-content">
    <div id="playerContainer">
        <video controls id="mainVideo"></video>
        <div id="currentVideoInfo">
            <span id="videoTitle"></span>
            <div style="position:relative; display:flex; align-items:center;">
                <button id="shareBtn">åˆ†äº«</button>
                <div id="videoMoreMenu"
                     style="display:none; position:absolute; top:28px; right:0; background:#fff; border:1px solid #ccc; border-radius:4px; box-shadow:0 2px 6px rgba(0,0,0,0.15); z-index:300; flex-direction:column;">
                    <button onclick="deleteCurrentVideo()"
                            style="padding:6px 12px; background:none; border:none; text-align:left; cursor:pointer;">
                        åˆ é™¤è§†é¢‘
                    </button>
                </div>
                <button id="videoMoreBtn">â‹®</button>
            </div>
        </div>
    </div>
    <div class="media-grid" id="mediaGrid"></div>
</div>

<div id="toastContainer"></div>

<div id="qrModal">
    <div id="qrModalContent">
        <span id="qrClose">Ã—</span>
        <h3>åˆ†äº«è§†é¢‘é“¾æ¥</h3>
        <div id="qrCodeContainer"></div>
        <input id="qrUrlInput" readonly type="text"/>
    </div>
</div>

<script src="/nas/js/qrcode.min.js"></script>
<script>
    const API = {
     matchThumbnails: "/nas/api/media/matchThumbnails"
 };
 let videoItems=[], thumbMode=false, orderField='createTime', orderDirection='desc', keyword='';
 let currentVideo=null;

 // -------------------- è®¾ç½®ç»„ --------------------
 function setupButtonGroup(groupId, callback){
     const group=document.getElementById(groupId);
     group.querySelectorAll('button').forEach(btn=>{
         btn.addEventListener('click',()=>{
             group.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
             btn.classList.add('active');
             callback(btn.dataset.value);
         });
     });
 }
 setupButtonGroup('orderFieldGroup', val=>{ orderField=val; loadMedia(); });
 setupButtonGroup('orderDirectionGroup', val=>{ orderDirection=val; loadMedia(); });
 setupButtonGroup('thumbModeGroup', val=>{ thumbMode=val==='true'; renderGrid(); });

 // -------------------- è®¾ç½®å¼¹çª— --------------------
 const settingsBtn = document.getElementById('settingsBtn');
 const settingsPanel = document.getElementById('settingsPanel');
 settingsBtn.addEventListener('click', e=>{
     e.stopPropagation();
     settingsPanel.style.display = settingsPanel.style.display==='flex'?'none':'flex';
 });

 // -------------------- æœç´¢ --------------------
 const searchInput = document.getElementById('searchInput');
 const searchBtnEl = document.getElementById('searchBtn');
 function doSearch(){ keyword = searchInput.value.trim(); loadMedia(); }
 searchBtnEl.addEventListener('click', doSearch);
 searchInput.addEventListener('keypress', e=>{if(e.key==='Enter') doSearch();});

 // -------------------- æ’­æ”¾åˆ—è¡¨ --------------------
 function getDefaultVideoThumbnail(){
     const svg=`<svg width="160" height="90" xmlns="http://www.w3.org/2000/svg">
         <rect width="160" height="90" rx="6" fill="#2a2a2a"/>
         <polygon points="65,30 65,60 100,45" fill="white"/>
     </svg>`;
     return "data:image/svg+xml;base64,"+btoa(svg);
 }

 async function loadMedia(){
     const params = new URLSearchParams({pageNumber:1,pageSize:90000,mediaType:'VIDEO',orderField,orderDirection,keyword});
     const res = await fetch('/nas/api/media/home?' + params.toString());
     const data = await res.json();
     videoItems = data.content || [];
     renderGrid();
 }

 function renderGrid(){
     const grid=document.getElementById('mediaGrid');
     grid.innerHTML='';
     videoItems.forEach(item=>{
         const card=document.createElement('div'); card.className='media-card';
         let thumbs=Array.from(item.thumbnails||[]);
         if(thumbs.length===0) thumbs=[getDefaultVideoThumbnail()];
         const img=document.createElement('img'); img.src=thumbs[0]; card.appendChild(img);

         if(thumbMode && thumbs.length>1){
             let idx=0, intervalId=null;
             const startCarousel=()=>{ if(intervalId) clearInterval(intervalId); intervalId=setInterval(()=>{ idx=(idx+1)%thumbs.length; img.src=thumbs[idx]; },800); };
             const stopCarousel=()=>{ if(intervalId) clearInterval(intervalId); intervalId=null; img.src=thumbs[0]; };
             card.addEventListener('mouseenter',startCarousel);
             card.addEventListener('mouseleave',stopCarousel);
         }

         card.addEventListener('click',()=>playVideo(item));
         grid.appendChild(card);
     });
 }

 // -------------------- æ’­æ”¾å™¨ --------------------
 const playerContainer=document.getElementById('playerContainer');
 const mainVideo=document.getElementById('mainVideo');
 const videoTitle=document.getElementById('videoTitle');
 const videoMoreBtnEl = document.getElementById('videoMoreBtn');
 const videoMoreMenu = document.getElementById('videoMoreMenu');
 const shareBtn = document.getElementById('shareBtn');

 function playVideo(item){
     currentVideo=item;
     mainVideo.src=item.url;
     videoTitle.textContent=item.displayName;
     playerContainer.style.display='flex';
     mainVideo.scrollIntoView({behavior:'smooth'});
 }

 // è§†é¢‘æ›´å¤šèœå•é€»è¾‘
 videoMoreBtnEl.addEventListener('click', e=>{
     e.stopPropagation();
     videoMoreMenu.style.display = videoMoreMenu.style.display==='flex'?'none':'flex';
 });

 // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•æˆ–è®¾ç½®é¢æ¿æˆ–äºŒç»´ç 
 document.addEventListener('click', e=>{
     if(settingsPanel.style.display==='flex' && !settingsPanel.contains(e.target) && e.target!==settingsBtn) settingsPanel.style.display='none';
     if(videoMoreMenu.style.display==='flex' && !videoMoreMenu.contains(e.target) && e.target!==videoMoreBtnEl) videoMoreMenu.style.display='none';
 });

 // Escé”®å…³é—­
 document.addEventListener('keydown', e=>{
     if(e.key==="Escape"){
         if(settingsPanel.style.display==='flex') settingsPanel.style.display='none';
         if(videoMoreMenu.style.display==='flex') videoMoreMenu.style.display='none';
         if(qrModal.style.display==='flex') qrModal.style.display='none';
     }
 });

 // åˆ é™¤å½“å‰æ’­æ”¾è§†é¢‘
 function deleteCurrentVideo(){
     if(!currentVideo) return;
     if(confirm(`ç¡®å®šåˆ é™¤è§†é¢‘ï¼š${currentVideo.displayName}?`)){
         fetch(`/nas/api/media/remove/${currentVideo.code}`)
             .then(r=>r.json())
             .then(ok=>{
                 showToast(ok?"åˆ é™¤æˆåŠŸ":"åˆ é™¤å¤±è´¥");
                 loadMedia();
                 playerContainer.style.display='none';
                 videoMoreMenu.style.display='none';
             });
     }
 }

 // -------------------- äºŒç»´ç åˆ†äº« --------------------
 const qrModal=document.getElementById('qrModal');
 const qrClose=document.getElementById('qrClose');
 const qrContainer=document.getElementById('qrCodeContainer');
 const qrUrlInput=document.getElementById('qrUrlInput');
 let qrInstance=null;

 shareBtn.addEventListener('click', ()=>{
     const url = window.location.href;
     qrUrlInput.value = url;
     if(!qrInstance) qrInstance = new QRCode(qrContainer,{width:160,height:160,correctLevel:QRCode.CorrectLevel.H});
     qrInstance.clear();
     qrInstance.makeCode(url);
     qrModal.style.display='flex';
 });

 qrClose.addEventListener('click', ()=>qrModal.style.display='none');
 qrModal.addEventListener('click', e=>{if(e.target===qrModal) qrModal.style.display='none';});

 // -------------------- åˆ·æ–°ç¼©ç•¥å›¾ --------------------
 const refreshThumbBtn = document.getElementById('refreshThumbBtn');
 refreshThumbBtn.addEventListener('click', async ()=>{
     if(confirm("ç¡®å®šåˆ·æ–°æ‰€æœ‰è§†é¢‘ç¼©ç•¥å›¾å—ï¼Ÿ")){
         try{
             const res = await fetch('/nas/api/media/matchThumbnails',{
                 method:'POST',
                 headers:{'Content-Type':'application/json'},
                 body:JSON.stringify({force:true,width:480,overwrite:true})
             });
             const data = await res.json();
             showToast("åˆ·æ–°ç¼©ç•¥å›¾è¯·æ±‚å·²å‘é€");
             loadMedia();
         }catch(err){
             showToast("åˆ·æ–°å¤±è´¥ï¼š"+err.message);
         }
     }
 });

 // -------------------- Toast --------------------
 function showToast(msg){
     const c=document.getElementById('toastContainer');
     const d=document.createElement('div');
     Object.assign(d.style,{
         background:"rgba(0,0,0,0.8)", color:"#fff", padding:"10px 16px",
         borderRadius:"8px", marginTop:"8px", opacity:"0", transform:"translateY(-20px)",
         transition:"0.3s"
     });
     d.textContent=msg; c.appendChild(d);
     requestAnimationFrame(()=>{d.style.opacity="1"; d.style.transform="translateY(0)";});
     setTimeout(()=>{ d.style.opacity="0"; setTimeout(()=>c.removeChild(d),300); },2000);
 }

 // åˆå§‹åŒ–åŠ è½½
 window.onload=loadMedia;
</script>
</body>
</html>
